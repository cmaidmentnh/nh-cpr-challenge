{% extends "base.html" %}
{% block title %}Find a Training{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    #trainings-map { height: 450px; }
    @media (max-width: 768px) { #trainings-map { height: 300px; } }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-navy-900 mb-2">Find a Training Near You</h1>
    <p class="text-gray-600 mb-6">Browse the map or scroll down to see all upcoming free CPR trainings during EMS Week (May 17&ndash;23).</p>

    <!-- Map -->
    <div id="trainings-map" class="rounded-xl shadow-md mb-8 border border-gray-200"></div>

    <!-- Filters -->
    <div class="flex flex-wrap gap-3 mb-6">
        <a href="{{ url_for('trainings') }}" class="px-4 py-2 rounded-full text-sm font-medium {% if not district_filter %}bg-navy-900 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} transition">
            All Districts
        </a>
        {% for d in range(1, 6) %}
        <a href="{{ url_for('trainings', district=d) }}" class="px-4 py-2 rounded-full text-sm font-medium {% if district_filter == d %}bg-navy-900 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} transition">
            District {{ d }} &mdash; {{ councilors[d]['name'] }}
        </a>
        {% endfor %}
    </div>

    <!-- Training List -->
    {% if trainings %}
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for t in trainings %}
        <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden hover:shadow-lg transition">
            <div class="h-2" style="background-color: {{ district_colors[t.district] }}"></div>
            <div class="p-6">
                <div class="flex items-center gap-2 mb-3">
                    <span class="w-3 h-3 rounded-full" style="background-color: {{ district_colors[t.district] }}"></span>
                    <span class="text-sm text-gray-500">District {{ t.district }}</span>
                    {% if t.is_full %}
                    <span class="ml-auto bg-red-100 text-red-700 text-xs px-2 py-1 rounded-full font-medium">FULL</span>
                    {% endif %}
                </div>
                <h3 class="font-bold text-navy-900 text-lg">{{ t.location_name }}</h3>
                {% if t.organization %}
                <p class="text-gray-500 text-sm">Hosted by {{ t.organization }}</p>
                {% endif %}
                <div class="mt-3 space-y-1 text-sm text-gray-600">
                    <p>&#128197; {{ t.date.strftime('%A, %B %d, %Y') }}</p>
                    <p>&#128336; {{ t.start_time or 'TBD' }}{% if t.end_time %} &ndash; {{ t.end_time }}{% endif %}</p>
                    <p>&#128205; {{ t.city or '' }}{% if t.address %}, {{ t.address }}{% endif %}</p>
                </div>
                {% if t.description %}
                <p class="mt-3 text-sm text-gray-500">{{ t.description[:150] }}{% if t.description|length > 150 %}...{% endif %}</p>
                {% endif %}
                <div class="mt-4 flex justify-between items-center">
                    <span class="text-sm text-gray-400">{{ t.spots_remaining }} of {{ t.capacity }} spots</span>
                    {% if not t.is_full %}
                    <a href="{{ url_for('rsvp', training_id=t.id) }}" class="bg-gold hover:bg-gold-dark text-navy-900 px-5 py-2 rounded-lg text-sm font-bold transition">
                        RSVP
                    </a>
                    {% else %}
                    <span class="text-gray-400 text-sm">Full</span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-16 bg-white rounded-xl shadow-md">
        <div class="text-5xl mb-4">&#128197;</div>
        <h3 class="text-xl font-bold text-navy-900 mb-2">No Trainings Yet{% if district_filter %} in District {{ district_filter }}{% endif %}</h3>
        <p class="text-gray-600 mb-6">Trainings will be posted as EMS Week approaches. Want to help?</p>
        <a href="{{ url_for('host') }}" class="bg-navy-900 text-white px-6 py-3 rounded-lg font-bold hover:bg-navy-800 transition">Host a Training</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/map.js') }}"></script>
<script>
    initTrainingsMap('trainings-map', {{ district_filter or 'null' }});
</script>
{% endblock %}
