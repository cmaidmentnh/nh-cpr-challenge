{% extends "base.html" %}
{% block title %}Find a Free CPR Training Near You in NH{% endblock %}
{% block meta_description %}Browse upcoming free Hands-Only CPR trainings across New Hampshire during EMS Week 2026 (May 17-23). Filter by Executive Council district. RSVP online — completely free, 15 minutes, no experience needed.{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    #trainings-map { height: calc(100vh - 220px); min-height: 500px; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <h1 class="font-serif text-3xl font-bold text-navy-900 mb-2">Find a Training Near You</h1>
    <p class="text-gray-600 mb-6">Browse upcoming free CPR trainings during EMS Week (May 17&ndash;23). Click a district on the map to filter.</p>

    <!-- Keep Me Updated — prominent placement -->
    <div class="bg-navy-50 border border-gray-200 p-5 border border-navy-100 mb-6">
        <div class="flex flex-col md:flex-row md:items-center gap-4">
            <div class="flex-shrink-0">
                <h3 class="font-serif font-bold text-navy-900 text-base">Get Notified About Trainings</h3>
                <p class="text-sm text-gray-600">We'll email you when new trainings are posted in your area.</p>
            </div>
            <form method="POST" action="{{ url_for('subscribe') }}" class="flex flex-col sm:flex-row gap-2 flex-1">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="email" name="email" required placeholder="Your email address" class="flex-1 border border-gray-300 rounded px-4 py-2 text-sm focus:ring-2 focus:ring-navy-500 focus:border-navy-500">
                <select name="district" class="border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-navy-500 focus:border-navy-500">
                    <option value="">Any district</option>
                    {% for d in range(1, 6) %}
                    <option value="{{ d }}" {% if district_filter == d %}selected{% endif %}>District {{ d }} &mdash; {{ councilors[d]['name'] }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="bg-navy-900 text-white px-5 py-2 rounded text-sm font-bold hover:bg-navy-800 transition whitespace-nowrap">Notify Me</button>
            </form>
        </div>
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap gap-3 mb-6">
        <a href="{{ url_for('trainings') }}" class="px-4 py-2 rounded-full text-sm font-medium border {% if not district_filter %}bg-navy-900 text-white border-navy-900{% else %}bg-white text-gray-700 border-gray-300 hover:border-gray-400{% endif %} transition">
            All Districts
        </a>
        {% for d in range(1, 6) %}
        <a href="{{ url_for('trainings', district=d) }}" class="px-4 py-2 rounded-full text-sm font-medium border {% if district_filter == d %}bg-navy-900 text-white border-navy-900{% else %}bg-white text-gray-700 border-gray-300 hover:border-gray-400{% endif %} transition">
            District {{ d }} &mdash; {{ councilors[d]['name'] }}
        </a>
        {% endfor %}
    </div>

    <!-- Map (left) + List (right) — side by side on desktop, list-only on mobile -->
    <div class="flex gap-6">
        <!-- Map — hidden on mobile -->
        <div class="hidden md:block md:w-2/5 lg:w-1/3 flex-shrink-0">
            <div id="trainings-map" class="border border-gray-200 border border-gray-200 sticky top-4"></div>
        </div>

        <!-- Training list -->
        <div class="flex-1 min-w-0">
            {% if trainings %}
            <div class="space-y-4">
                {% for t in trainings %}
                <div class="bg-white border border-gray-200 border border-gray-100 overflow-hidden hover:border-navy-300 transition">
                    <div class="flex">
                        <div class="w-1.5 flex-shrink-0" style="background-color: {{ district_colors[t.district] }}"></div>
                        <div class="p-5 flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: {{ district_colors[t.district] }}"></span>
                                <span class="text-sm text-gray-500">District {{ t.district }}</span>
                                {% if t.is_full %}
                                <span class="ml-auto bg-red-50 text-red-700 text-xs px-2 py-1 rounded-full font-medium border border-red-200">FULL</span>
                                {% endif %}
                            </div>
                            <h3 class="font-bold text-navy-900 text-lg">{{ t.location_name }}</h3>
                            {% if t.organization %}
                            <p class="text-gray-500 text-sm">Hosted by {{ t.organization }}</p>
                            {% endif %}
                            <div class="mt-2 flex flex-wrap gap-x-4 gap-y-1 text-sm text-gray-600">
                                <span class="flex items-center gap-1.5">
                                    <svg class="w-4 h-4 text-gray-400 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                    {{ t.date.strftime('%a, %B %d') }}
                                </span>
                                <span class="flex items-center gap-1.5">
                                    <svg class="w-4 h-4 text-gray-400 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                    {{ t.start_time or 'TBD' }}{% if t.end_time %} &ndash; {{ t.end_time }}{% endif %}
                                </span>
                                <span class="flex items-center gap-1.5">
                                    <svg class="w-4 h-4 text-gray-400 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                    {{ t.city or '' }}{% if t.address %}, {{ t.address }}{% endif %}
                                </span>
                            </div>
                            {% if t.description %}
                            <p class="mt-2 text-sm text-gray-500">{{ t.description[:120] }}{% if t.description|length > 120 %}...{% endif %}</p>
                            {% endif %}
                            <div class="mt-3 flex justify-between items-center pt-3 border-t border-gray-100">
                                <span class="text-sm text-gray-400">{{ t.spots_remaining }} of {{ t.capacity }} spots</span>
                                {% if not t.is_full %}
                                <a href="{{ url_for('rsvp', training_id=t.id) }}" class="bg-gold hover:bg-gold-dark text-navy-900 px-5 py-2 rounded text-sm font-bold transition">
                                    RSVP
                                </a>
                                {% else %}
                                <span class="text-gray-400 text-sm italic">Full</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-16 bg-white border border-gray-200 border border-gray-100">
                <svg class="w-12 h-12 text-gray-300 mx-auto mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                <h3 class="text-xl font-bold text-navy-900 mb-2">No Trainings Yet{% if district_filter %} in District {{ district_filter }}{% endif %}</h3>
                <p class="text-gray-600 mb-6">Trainings will be posted as EMS Week approaches. Want to help?</p>
                <a href="{{ url_for('host') }}" class="bg-navy-900 text-white px-6 py-3 rounded font-bold hover:bg-navy-800 transition">Host a Training</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/map.js') }}"></script>
<script>
    if (document.getElementById('trainings-map')) {
        initTrainingsMap('trainings-map', {{ district_filter or 'null' }});
    }
</script>
{% endblock %}
