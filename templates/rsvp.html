{% extends "base.html" %}
{% block title %}RSVP - {{ training.location_name }}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 py-8">
    <!-- Training Details -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
        <div class="h-2" style="background-color: {{ district_colors[training.district] }}"></div>
        <div class="p-6">
            <div class="flex items-center gap-2 mb-2">
                <span class="w-3 h-3 rounded-full" style="background-color: {{ district_colors[training.district] }}"></span>
                <span class="text-sm text-gray-500">District {{ training.district }} &mdash; {{ councilors[training.district]['name'] }}</span>
            </div>
            <h1 class="text-2xl font-bold text-navy-900 mb-1">{{ training.location_name }}</h1>
            {% if training.organization %}
            <p class="text-gray-500">Hosted by {{ training.organization }}</p>
            {% endif %}
            <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                <div>
                    <span class="text-gray-400">Date</span>
                    <p class="font-medium text-gray-800">{{ training.date.strftime('%A, %B %d, %Y') }}</p>
                </div>
                <div>
                    <span class="text-gray-400">Time</span>
                    <p class="font-medium text-gray-800">{{ training.start_time or 'TBD' }}{% if training.end_time %} &ndash; {{ training.end_time }}{% endif %}</p>
                </div>
                <div>
                    <span class="text-gray-400">Location</span>
                    <p class="font-medium text-gray-800">{{ training.address or '' }}{% if training.address and training.city %}, {% endif %}{{ training.city or '' }}</p>
                </div>
                <div>
                    <span class="text-gray-400">Availability</span>
                    <p class="font-medium {% if training.is_full %}text-red-600{% else %}text-green-600{% endif %}">
                        {% if training.is_full %}Full{% else %}{{ training.spots_remaining }} spots remaining{% endif %}
                    </p>
                </div>
            </div>
            {% if training.description %}
            <p class="mt-4 text-gray-600 text-sm border-t border-gray-100 pt-4">{{ training.description }}</p>
            {% endif %}
        </div>
    </div>

    {% if training.is_full %}
    <!-- Full -->
    <div class="bg-red-50 rounded-xl p-8 text-center border border-red-200">
        <svg class="w-12 h-12 text-red-400 mx-auto mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="8" y1="15" x2="16" y2="15"/><line x1="9" y1="9" x2="9.01" y2="9" stroke-width="3" stroke-linecap="round"/><line x1="15" y1="9" x2="15.01" y2="9" stroke-width="3" stroke-linecap="round"/></svg>
        <h2 class="text-xl font-bold text-red-800 mb-2">This Training is Full</h2>
        <p class="text-red-600 mb-4">All {{ training.capacity }} spots have been filled.</p>
        <a href="{{ url_for('trainings') }}" class="inline-block bg-navy-900 text-white px-6 py-2 rounded-lg font-bold hover:bg-navy-800 transition">Find Another Training</a>
    </div>
    {% else %}
    <!-- RSVP Form -->
    <form method="POST" class="bg-white rounded-xl shadow-md p-8 space-y-5">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <h2 class="text-xl font-bold text-navy-900">Reserve Your Spot</h2>
        <p class="text-gray-600 text-sm">It's free! Just fill out the form below and you'll receive a confirmation email.</p>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Your Name *</label>
            <input type="text" name="name" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-navy-500 focus:border-navy-500">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
            <input type="email" name="email" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-navy-500 focus:border-navy-500">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Phone (optional)</label>
            <input type="tel" name="phone" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-navy-500 focus:border-navy-500">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Your Zip Code (to detect your district)</label>
            <input type="text" name="zip_for_district" id="rsvp-zip" maxlength="5" placeholder="e.g., 03301" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-navy-500 focus:border-navy-500">
            <p id="rsvp-district-msg" class="text-xs text-gray-400 mt-1">Enter your zip code and we'll detect your Executive Council district.</p>
            <input type="hidden" name="district" id="rsvp-district-hidden" value="">
        </div>

        <button type="submit" class="w-full bg-gold hover:bg-gold-dark text-navy-900 font-bold py-3 px-8 rounded-lg text-lg transition">
            Reserve My Spot
        </button>
    </form>
    {% endif %}

    <!-- Keep Me Updated -->
    <div class="mt-8 bg-navy-50 rounded-xl p-6 border border-navy-100">
        <h3 class="font-serif font-bold text-navy-900 mb-2">Stay Updated</h3>
        <p class="text-sm text-gray-600 mb-4">Want to hear about new trainings in your area? Sign up and we'll let you know.</p>
        <form method="POST" action="{{ url_for('subscribe') }}" class="flex flex-col sm:flex-row gap-3">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="email" name="email" required placeholder="Your email" class="flex-1 border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-navy-500 focus:border-navy-500">
            <select name="district" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-navy-500 focus:border-navy-500">
                <option value="">Any district</option>
                {% for d in range(1, 6) %}
                <option value="{{ d }}">District {{ d }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="bg-navy-900 text-white px-5 py-2 rounded-lg text-sm font-bold hover:bg-navy-800 transition whitespace-nowrap">Notify Me</button>
        </form>
    </div>
</div>

{% block extra_scripts %}
<script>
(function() {
    const zipInput = document.getElementById('rsvp-zip');
    const hiddenDistrict = document.getElementById('rsvp-district-hidden');
    const msg = document.getElementById('rsvp-district-msg');
    if (!zipInput) return;

    let timer = null;
    function detectFromZip() {
        const zip = zipInput.value.trim();
        if (zip.length < 5) return;

        msg.innerHTML = '<span class="text-navy-600">Detecting district...</span>';

        fetch('https://nominatim.openstreetmap.org/search?format=json&q=NH+' + encodeURIComponent(zip) + '&limit=1&countrycodes=us')
            .then(r => r.json())
            .then(results => {
                if (!results.length) {
                    msg.innerHTML = '<span class="text-gray-400">Could not find that zip code.</span>';
                    return;
                }
                const lat = parseFloat(results[0].lat);
                const lng = parseFloat(results[0].lon);
                return fetch('/api/detect-district?lat=' + lat + '&lng=' + lng);
            })
            .then(r => r ? r.json() : null)
            .then(data => {
                if (data && data.district) {
                    hiddenDistrict.value = data.district;
                    msg.innerHTML = '<svg class="w-4 h-4 text-green-600 inline-block mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg><span class="text-green-600">District ' + data.district + ' &mdash; ' + data.councilor + '</span>';
                } else if (data) {
                    msg.innerHTML = '<span class="text-gray-400">Could not determine district.</span>';
                }
            })
            .catch(() => {});
    }

    zipInput.addEventListener('input', function() {
        clearTimeout(timer);
        timer = setTimeout(detectFromZip, 600);
    });
    zipInput.addEventListener('blur', detectFromZip);
})();
</script>
{% endblock %}
